<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Realtime Chatting Application</title>
</head>

<body>

    {% if group_name is None %}
        <form action="{% url 'chat:chat-view' %}" method="get">
            <input type="text" name="group-name" maxlength="20" minlength="5" placeholder="Group Name" required><br>
            <button type="submit">Connect To this Group</button>
        </form>

    {% else %}
        <h1>Group Name: {{group_name}}</h1> <br><br><br>
        {{ group_name|json_script:'user_group_name'}}

        <textarea name="display_messages" id="display_messages" cols="30" rows="10"></textarea>
        <input type="text" name="text_message" id="text_message" required>
        <button type="submit" id="message-submit">Send</button>

        <script>
            const group_name = JSON.parse(document.getElementById('user_group_name').innerText);
            const ws = new WebSocket(  // for Synchronous Connection
                'ws://'
                + window.location.host
                + '/ws/chat/sc/'
                + group_name
                + '/'
            );

            // const ws = new WebSocket(    // for Asynchronous Connection
            //     'ws://'
            //     + window.location.host
            //     + '/ws/chat/ac/'
            //     + group_name
            //     + '/'
            // );

            ws.onopen = function (event) {
                console.log('Synchronous Connection Established.', event);
            };

            ws.onmessage = function (event) {
                console.log(event);
                var message_obj = JSON.parse(event.data);
                console.log(message_obj.message, 'Message Receive......');
                document.querySelector('#display_messages').value += message_obj.message + '\n';
            };

            ws.close = function (event) {
                console.log('Synchronous Connection Close.', event);
            };

            document.getElementById('message-submit').onclick = function (event) {
                const user_messages = document.getElementById('text_message').value;
                ws.send(JSON.stringify({'message': user_messages}));
            };

        </script>
    {% endif %}

</body>

</html>